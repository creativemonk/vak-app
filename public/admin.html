<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vāk Studio - Content Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sanskrit { font-family: 'Noto Sans Devanagari', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        dialog::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #f59e0b;
            margin-top: -6px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(245,158,11,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
        input[type=range]:focus::-webkit-slider-runnable-track {
            background: #475569;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen flex flex-col overflow-hidden selection:bg-amber-500 selection:text-black">

    <!-- Startup Modal (Project Loader) -->
    <div id="startupOverlay" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
        <div class="bg-slate-900 p-8 rounded-2xl border border-white/10 shadow-2xl max-w-md w-full text-center space-y-6">
            <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-600 rounded-2xl flex items-center justify-center font-bold text-3xl text-slate-950 mx-auto shadow-lg shadow-orange-500/20">ॐ</div>
            <div>
                <h1 class="text-2xl font-bold text-white">Vāk Studio</h1>
                <p class="text-slate-400 text-sm mt-2">Manage your chants, menus, and syncing.</p>
            </div>
            
            <div class="space-y-3">
                <button onclick="document.getElementById('startupImport').click()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20 group">
                    <i data-lucide="folder-open" class="w-5 h-5 group-hover:scale-110 transition"></i> Load 'vak_data.js'
                </button>
                <input type="file" id="startupImport" accept=".js,.json,.txt" class="hidden" onchange="importProject(this)">
                
                <button onclick="startNewProject()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 font-semibold rounded-xl transition">
                    Start New Project
                </button>
            </div>
            <div class="text-[10px] text-slate-600 pt-4 border-t border-white/5">
                Version 2.3 • Scrub, Tag & Edit
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="p-4 border-b border-white/10 bg-slate-900 flex justify-between items-center shadow-lg z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-orange-600 rounded-lg flex items-center justify-center font-bold text-slate-950">ॐ</div>
            <h1 class="font-bold text-lg tracking-wide text-slate-200">Vāk <span class="text-xs font-normal text-slate-500 uppercase tracking-widest ml-1">Studio</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="exportFullProject()" class="text-xs font-bold px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg flex items-center gap-2 transition shadow-lg shadow-green-900/20">
                <i data-lucide="save" class="w-3 h-3"></i> Save / Export
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- LEFT PANEL: CMS & INPUTS -->
        <div class="w-[400px] border-r border-white/5 bg-slate-900/80 flex flex-col overflow-y-auto z-10 shadow-xl custom-scrollbar shrink-0">
            
            <!-- SECTION A: MENU MANAGER -->
            <div class="p-6 border-b border-white/5 space-y-5 bg-slate-900/50">
                <div class="flex justify-between items-center">
                    <h2 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="menu" class="w-3 h-3"></i> Menu Structure
                    </h2>
                </div>

                <!-- Category Manager -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center text-[10px] uppercase font-bold text-slate-500">
                        <span>Main Menu (Category)</span>
                        <button onclick="addCategory()" class="text-blue-400 hover:text-blue-300">+ Add New</button>
                    </div>
                    <div class="flex gap-2">
                        <select id="categorySelect" onchange="handleCategoryChange()" class="flex-1 bg-slate-800 border border-white/10 rounded px-3 py-2 text-sm focus:border-amber-500 outline-none transition-colors">
                            <!-- Options populated by JS -->
                        </select>
                        <button onclick="deleteCategory()" title="Delete Category" class="px-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded border border-red-500/20 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <!-- Script Manager -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center text-[10px] uppercase font-bold text-slate-500">
                        <span>Sub Menu (Script)</span>
                        <button onclick="addScript()" class="text-blue-400 hover:text-blue-300">+ Add New</button>
                    </div>
                    <div class="flex gap-2">
                        <select id="scriptSelect" onchange="handleScriptChange()" class="flex-1 bg-slate-800 border border-white/10 rounded px-3 py-2 text-sm focus:border-amber-500 outline-none transition-colors">
                            <!-- Options populated by JS -->
                        </select>
                        <button onclick="deleteScript()" title="Delete Script" class="px-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded border border-red-500/20 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>

            <!-- SECTION B: CONTENT EDITOR -->
            <div class="p-6 space-y-6 flex-1 relative">
                
                <!-- Metadata Overlay if no script selected -->
                <div id="noSelectionOverlay" class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-20 flex flex-col items-center justify-center text-center p-6" style="display: none;">
                    <i data-lucide="mouse-pointer-2" class="w-8 h-8 text-slate-500 mb-2"></i>
                    <p class="text-slate-400 text-sm">Select or Create a Script<br>to edit content.</p>
                </div>

                <!-- Metadata Inputs -->
                <div class="space-y-4">
                    <h2 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="file-text" class="w-3 h-3"></i> Page Header
                    </h2>
                    
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block">Title</label>
                        <input type="text" id="titleInput" class="w-full bg-slate-800 border border-white/10 rounded px-3 py-2 text-sm focus:border-amber-500 outline-none transition-colors" placeholder="e.g. Guru Ashtakam">
                    </div>

                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block">Intro / Meaning</label>
                        <textarea id="meaningInput" class="w-full h-20 bg-slate-800 border border-white/10 rounded px-3 py-2 text-xs focus:border-amber-500 outline-none resize-none transition-colors" placeholder="Enter the text to display below the title..."></textarea>
                    </div>
                </div>

                <!-- Audio -->
                <div class="space-y-4 pt-4 border-t border-white/5">
                    <h2 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="music" class="w-3 h-3"></i> Audio Settings
                    </h2>
                    
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block">Production URL</label>
                        <input type="text" id="audioUrlInput" class="w-full bg-slate-800 border border-white/10 rounded px-3 py-2 text-xs font-mono text-green-400 focus:border-amber-500 outline-none transition-colors" placeholder="/audio/filename.mp3">
                    </div>

                    <div class="bg-slate-800/50 p-3 rounded-lg border border-white/5">
                        <label class="text-[10px] text-amber-500 uppercase font-bold mb-1 block">Local Sync File</label>
                        <input type="file" id="audioInput" accept="audio/*" class="block w-full text-xs text-slate-400 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600 cursor-pointer"/>
                    </div>
                </div>

                <!-- Scripts -->
                <div class="space-y-4 pt-4 border-t border-white/5">
                    <h2 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="align-left" class="w-3 h-3"></i> Lyrics (Paste Here)
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 uppercase font-bold">Sanskrit</label>
                            <textarea id="sanskritInput" class="w-full h-40 bg-slate-800 border border-white/10 rounded px-3 py-2 text-sm sanskrit focus:border-amber-500 outline-none resize-none transition-colors" placeholder="Paste Sanskrit..."></textarea>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 uppercase font-bold">English</label>
                            <textarea id="transInput" class="w-full h-40 bg-slate-800 border border-white/10 rounded px-3 py-2 text-sm font-mono focus:border-amber-500 outline-none resize-none transition-colors" placeholder="Paste English..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Load Action -->
                <div class="pt-2 sticky bottom-0 bg-slate-900 py-4 border-t border-white/5">
                    <button onclick="loadToWorkspace()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition shadow-lg text-sm flex items-center justify-center gap-2">
                        Load to Sync Workspace <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>

            </div>
        </div>

        <!-- RIGHT PANEL: WORKSPACE -->
        <div class="flex-1 flex flex-col relative bg-slate-950">
            
            <!-- Karaoke Display -->
            <div id="workspace" class="flex-1 p-8 md:p-12 overflow-y-auto flex flex-wrap content-start gap-4 transition-colors no-scrollbar content-center justify-center">
                <div class="text-center opacity-30 select-none">
                    <i data-lucide="music-2" class="w-16 h-16 mx-auto mb-4"></i>
                    <p class="text-lg font-medium">Sync Workspace</p>
                    <p class="text-sm">Load a script to begin.</p>
                </div>
            </div>

            <!-- Editor/Player Bar -->
            <div class="bg-slate-900 border-t border-white/10 p-4 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
                
                <div class="flex items-center gap-6 mb-4">
                    <!-- Controls -->
                    <div class="flex items-center gap-3">
                        <button id="playBtn" onclick="togglePlayback()" disabled class="w-12 h-12 rounded-full flex items-center justify-center bg-slate-800 border border-slate-600 text-white hover:border-green-500 hover:bg-green-500/10 transition-all disabled:opacity-30 disabled:cursor-not-allowed group">
                            <i data-lucide="play" id="playIcon" class="w-5 h-5 text-green-500 fill-current group-hover:scale-110 transition-transform"></i>
                        </button>
                        
                        <button id="keyframeBtn" onclick="setKeyframe()" disabled class="w-12 h-12 rounded-full flex items-center justify-center bg-amber-600 border border-amber-500 text-white shadow-lg hover:bg-amber-500 transition-all disabled:opacity-30 disabled:cursor-not-allowed group" title="Set Keyframe at Current Time (Enter)">
                            <i data-lucide="map-pin" class="w-5 h-5 fill-current group-hover:scale-110 transition-transform"></i>
                        </button>
                    </div>

                    <!-- Timeline -->
                    <div class="flex-1 space-y-1">
                        <div class="flex justify-between items-end text-xs font-mono">
                            <span id="statusText" class="text-slate-400">Ready</span>
                            <span id="currentTime" class="text-amber-500 tabular-nums">0.00s</span>
                        </div>
                        <input 
                            type="range" 
                            id="seekSlider" 
                            min="0" 
                            max="100" 
                            value="0" 
                            disabled
                            oninput="handleSeek(this.value)"
                            class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer disabled:cursor-not-allowed"
                        />
                    </div>

                    <!-- Save -->
                    <button onclick="saveSyncData()" id="saveSyncBtn" disabled class="px-6 py-3 bg-slate-800 text-green-500 border border-green-500/30 hover:bg-green-500 hover:text-white rounded-lg text-xs font-bold uppercase tracking-wider transition disabled:opacity-30 flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> Save
                    </button>
                </div>
                
                <div class="text-[10px] text-slate-500 text-center flex justify-center gap-4">
                    <span><strong class="text-slate-400">Space</strong> Play/Pause</span>
                    <span><strong class="text-slate-400">Drag Slider</strong> Scrub</span>
                    <span><strong class="text-slate-400">Click Word</strong> Select</span>
                    <span><strong class="text-slate-400">Enter / Click Pin</strong> Set Start Time</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <dialog id="exportModal" class="bg-slate-900 text-white p-0 rounded-2xl border border-white/10 shadow-2xl w-full max-w-3xl backdrop:bg-black/90">
        <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50">
            <div>
                <h3 class="text-lg font-bold text-amber-500">Project Export</h3>
                <p class="text-xs text-slate-400">Save this content to 'vak_data.js'</p>
            </div>
            <button onclick="document.getElementById('exportModal').close()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="p-0">
            <textarea id="jsonOutput" class="w-full h-80 bg-black/50 p-6 font-mono text-xs text-green-400 focus:outline-none resize-none"></textarea>
        </div>
        <div class="p-4 border-t border-white/10 bg-slate-800/30 flex justify-end">
            <button onclick="navigator.clipboard.writeText(document.getElementById('jsonOutput').value); this.innerText='Copied!'" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold transition flex items-center gap-2">
                <i data-lucide="copy" class="w-4 h-4"></i> Copy to Clipboard
            </button>
        </div>
    </dialog>

    <script>
        lucide.createIcons();

        // --- GLOBAL STATE ---
        let projectData = [];
        let activeCategoryId = null;
        let activeScriptId = null;
        
        let audioPlayer = new Audio();
        let wordBlocks = []; 
        let wordTimings = [];
        
        // Editor State
        let selectedWordIndex = null;
        let isPlaying = false;
        let animationFrame;

        // --- AUDIO EVENTS ---
        audioPlayer.addEventListener('timeupdate', () => {
            // Native timeupdate is too slow for smooth UI, relying on requestAnimationFrame loop
        });
        
        audioPlayer.addEventListener('ended', () => {
            if(isPlaying) togglePlayback();
        });

        // --- STARTUP LOGIC ---
        function startNewProject() {
            projectData = [{ id: 'cat_1', name: 'Daily Chants', scripts: [] }];
            activeCategoryId = 'cat_1';
            document.getElementById('startupOverlay').style.display = 'none';
            renderStructure();
        }

        function importProject(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let raw = e.target.result;
                    raw = raw.replace(/const\s+DATA\s+=\s+/, '').replace(/export\s+default\s+DATA;?/, '').replace(/;\s*$/, '');
                    projectData = JSON.parse(raw);
                    activeCategoryId = projectData[0]?.id;
                    activeScriptId = null;
                    document.getElementById('startupOverlay').style.display = 'none';
                    renderStructure();
                } catch (err) {
                    alert("Error parsing file.");
                }
            };
            reader.readAsText(file);
        }

        // --- CMS LOGIC ---
        function renderStructure() {
            const catSelect = document.getElementById('categorySelect');
            catSelect.innerHTML = '';
            projectData.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.text = cat.name;
                opt.selected = cat.id === activeCategoryId;
                catSelect.appendChild(opt);
            });
            if(projectData.length === 0) {
                const opt = document.createElement('option'); opt.text = "No Categories"; catSelect.appendChild(opt);
            }

            const scriptSelect = document.getElementById('scriptSelect');
            scriptSelect.innerHTML = '';
            const currentCat = projectData.find(c => c.id === activeCategoryId);
            
            if (currentCat && currentCat.scripts.length > 0) {
                currentCat.scripts.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.text = s.title || "Untitled Script";
                    opt.selected = s.id === activeScriptId;
                    scriptSelect.appendChild(opt);
                });
                if (!activeScriptId) { activeScriptId = currentCat.scripts[0].id; scriptSelect.value = activeScriptId; }
            } else {
                const opt = document.createElement('option'); opt.text = "-- No Scripts --"; scriptSelect.appendChild(opt);
                activeScriptId = null;
            }
            populateEditor();
        }

        function populateEditor() {
            const overlay = document.getElementById('noSelectionOverlay');
            if(!activeScriptId) { overlay.style.display = 'flex'; return; }
            overlay.style.display = 'none';

            const cat = projectData.find(c => c.id === activeCategoryId);
            const script = cat.scripts.find(s => s.id === activeScriptId);

            if (script) {
                document.getElementById('titleInput').value = script.title || "";
                document.getElementById('meaningInput').value = script.meaning || "";
                const mp3Source = script.sources ? script.sources.find(s => s.type === 'audio/mpeg') : null;
                document.getElementById('audioUrlInput').value = mp3Source ? mp3Source.src : "";

                if (script.content && script.content.length > 0) {
                    document.getElementById('sanskritInput').value = script.content.map(c => c.word).join(" ");
                    document.getElementById('transInput').value = script.content.map(c => c.trans).join(" ");
                    
                    // Pre-load timings if available
                    wordTimings = script.content.map(c => ({ start: c.start, end: c.end }));
                } else {
                    document.getElementById('sanskritInput').value = script.rawSanskrit || "";
                    document.getElementById('transInput').value = script.rawTrans || "";
                    wordTimings = [];
                }
            }
        }

        function saveCurrentScriptMetadata() {
            if (!activeScriptId) return;
            const cat = projectData.find(c => c.id === activeCategoryId);
            const script = cat.scripts.find(s => s.id === activeScriptId);
            
            script.title = document.getElementById('titleInput').value;
            script.meaning = document.getElementById('meaningInput').value;
            const audioUrl = document.getElementById('audioUrlInput').value;
            if (audioUrl) script.sources = [{ src: audioUrl, type: 'audio/mpeg' }];
            script.rawSanskrit = document.getElementById('sanskritInput').value;
            script.rawTrans = document.getElementById('transInput').value;
            
            const scriptSelect = document.getElementById('scriptSelect');
            const opt = scriptSelect.querySelector(`option[value="${activeScriptId}"]`);
            if(opt) opt.text = script.title;
        }

        function handleCategoryChange() { activeCategoryId = document.getElementById('categorySelect').value; activeScriptId = null; renderStructure(); }
        function handleScriptChange() { activeScriptId = document.getElementById('scriptSelect').value; populateEditor(); }
        function addCategory() { const name = prompt("Enter Category Name:"); if (name) { const id = 'cat_' + Date.now(); projectData.push({ id, name, scripts: [] }); activeCategoryId = id; activeScriptId = null; renderStructure(); } }
        function deleteCategory() { if (confirm("Delete this category?")) { projectData = projectData.filter(c => c.id !== activeCategoryId); activeCategoryId = projectData.length > 0 ? projectData[0].id : null; activeScriptId = null; renderStructure(); } }
        function addScript() { if (!activeCategoryId) return alert("Create a category first."); const cat = projectData.find(c => c.id === activeCategoryId); const id = 'script_' + Date.now(); cat.scripts.push({ id, title: "New Chant", sources: [], content: [] }); activeScriptId = id; renderStructure(); }
        function deleteScript() { if (!activeScriptId) return; if (confirm("Delete this script?")) { const cat = projectData.find(c => c.id === activeCategoryId); cat.scripts = cat.scripts.filter(s => s.id !== activeScriptId); activeScriptId = null; renderStructure(); } }

        // --- WORKSPACE INIT ---

        function loadToWorkspace() {
            saveCurrentScriptMetadata();
            const file = document.getElementById('audioInput').files[0];
            const sText = document.getElementById('sanskritInput').value.trim();
            const tText = document.getElementById('transInput').value.trim();

            if (!file && !audioPlayer.src) return alert("Please upload a local Audio file.");
            if (!sText) return alert("Sanskrit text is empty.");

            if(file) {
                audioPlayer.src = URL.createObjectURL(file);
                audioPlayer.load();
            }

            const sWords = sText.split(/\s+/).filter(w => w.length > 0);
            const tWords = tText ? tText.split(/\s+/).filter(w => w.length > 0) : [];

            wordBlocks = sWords.map((word, i) => ({ sanskrit: word, trans: tWords[i] || "" }));

            const ws = document.getElementById('workspace');
            ws.innerHTML = '';
            ws.className = "flex-1 p-8 md:p-12 overflow-y-auto flex flex-wrap content-start gap-4 transition-colors no-scrollbar";
            
            if(wordTimings.length !== wordBlocks.length) {
                wordTimings = new Array(wordBlocks.length).fill(null);
            }

            wordBlocks.forEach((block, i) => {
                const div = document.createElement('div');
                div.id = `word-${i}`;
                div.onclick = (e) => { 
                    if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I' && e.target.tagName !== 'INPUT') selectWord(i); 
                };
                div.className = `group flex flex-col p-2 rounded border border-white/5 bg-slate-900 transition-all opacity-60 text-center select-none relative min-w-[100px] cursor-pointer hover:border-white/20`;
                
                div.innerHTML = `
                    <div class="text-lg font-bold text-slate-200 sanskrit mb-1 pointer-events-none">${block.sanskrit}</div>
                    <div class="text-[10px] text-slate-500 font-mono pointer-events-none mb-1">${block.trans}</div>
                    
                    <!-- Manual Timing Inputs -->
                    <div class="mt-2 flex gap-1 justify-center opacity-50 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                        <input type="number" step="0.1" value="${wordTimings[i]?.start?.toFixed(2) || 0}" class="w-12 bg-black/50 text-[10px] text-green-400 text-center rounded border border-white/10 focus:border-green-500 outline-none p-0.5" onchange="manualUpdateTiming(${i}, 'start', this.value)">
                        <input type="number" step="0.1" value="${wordTimings[i]?.end?.toFixed(2) || 0}" class="w-12 bg-black/50 text-[10px] text-red-400 text-center rounded border border-white/10 focus:border-red-500 outline-none p-0.5" onchange="manualUpdateTiming(${i}, 'end', this.value)">
                    </div>

                    <!-- Status Dot -->
                    <div id="dot-${i}" class="w-1.5 h-1.5 rounded-full bg-green-500 mx-auto mt-2 ${wordTimings[i] && wordTimings[i].end > 0 ? '' : 'hidden'}"></div>
                    
                    <!-- Word Play Button -->
                    <button onclick="playSegment(${i}); event.stopPropagation();" class="absolute -top-2 -right-2 w-6 h-6 bg-blue-600 rounded-full text-white flex items-center justify-center opacity-0 group-hover:opacity-100 shadow-lg hover:scale-110 transition z-10"><i data-lucide="play" class="w-3 h-3 fill-current"></i></button>
                `;
                ws.appendChild(div);
            });
            lucide.createIcons();

            document.getElementById('playBtn').disabled = false;
            document.getElementById('keyframeBtn').disabled = false;
            document.getElementById('seekSlider').disabled = false;
            document.getElementById('saveSyncBtn').disabled = false;
            
            // Select first word
            selectWord(0);
        }

        // --- EDITING LOGIC ---

        function manualUpdateTiming(index, field, value) {
            if(!wordTimings[index]) wordTimings[index] = { start: 0, end: 0 };
            wordTimings[index][field] = parseFloat(value);
            // Visual Update
            if(wordTimings[index].end > wordTimings[index].start) {
                document.getElementById(`dot-${index}`).classList.remove('hidden');
            }
        }

        function refreshWordInputs(index) {
            const el = document.getElementById(`word-${index}`);
            if(!el) return;
            const inputs = el.querySelectorAll('input');
            if(wordTimings[index]) {
                inputs[0].value = wordTimings[index].start.toFixed(2);
                inputs[1].value = wordTimings[index].end.toFixed(2);
                document.getElementById(`dot-${index}`).classList.remove('hidden');
            } else {
                inputs[0].value = 0;
                inputs[1].value = 0;
                document.getElementById(`dot-${index}`).classList.add('hidden');
            }
        }

        function selectWord(idx) {
            if(selectedWordIndex !== null) {
                // Deselect prev visual
                const prev = document.getElementById(`word-${selectedWordIndex}`);
                if(prev) prev.classList.remove('ring-2', 'ring-blue-500', 'bg-slate-800', 'opacity-100');
            }
            
            selectedWordIndex = idx;
            const el = document.getElementById(`word-${idx}`);
            if(el) {
                el.classList.add('ring-2', 'ring-blue-500', 'bg-slate-800', 'opacity-100');
                el.classList.remove('opacity-60');
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function togglePlayback() {
            if(isPlaying) {
                isPlaying = false;
                audioPlayer.pause();
                cancelAnimationFrame(animationFrame);
                document.getElementById('playIcon').setAttribute('data-lucide', 'play');
                lucide.createIcons();
            } else {
                isPlaying = true;
                audioPlayer.play();
                document.getElementById('playIcon').setAttribute('data-lucide', 'pause');
                lucide.createIcons();
                updateLoop();
            }
        }

        function handleSeek(val) {
            const time = (val / 100) * audioPlayer.duration;
            audioPlayer.currentTime = time;
            document.getElementById('currentTime').innerText = time.toFixed(2) + "s";
            
            // Auto-select word matching this time?
            // Optional: depends if user wants selection to follow scrubber
            // Let's keep manual selection for now to avoid jumping
        }

        function setKeyframe() {
            if (selectedWordIndex === null) return;
            const now = audioPlayer.currentTime;

            // Toggle Logic: If clicking on same word and it already has start time ~= now, remove it?
            // Actually, simplified logic requested: Click adds, click again removes.
            
            if (wordTimings[selectedWordIndex] && Math.abs(wordTimings[selectedWordIndex].start - now) < 0.5) {
                // Remove
                wordTimings[selectedWordIndex] = null;
                refreshWordInputs(selectedWordIndex);
            } else {
                // Add / Update
                // 1. Set Start
                if(!wordTimings[selectedWordIndex]) wordTimings[selectedWordIndex] = { start: 0, end: 0 };
                wordTimings[selectedWordIndex].start = now;
                
                // 2. Set End of PREVIOUS word (Continuity)
                if (selectedWordIndex > 0 && wordTimings[selectedWordIndex - 1]) {
                    wordTimings[selectedWordIndex - 1].end = now;
                    refreshWordInputs(selectedWordIndex - 1);
                }
                
                refreshWordInputs(selectedWordIndex);
                
                // Auto-advance selection
                if (selectedWordIndex < wordBlocks.length - 1) {
                    selectWord(selectedWordIndex + 1);
                }
            }
        }

        function playSegment(i) {
            const start = wordTimings[i]?.start || 0;
            const end = wordTimings[i]?.end || (start + 2); // Default 2s play
            
            if(isPlaying) togglePlayback(); // Stop main loop
            
            audioPlayer.currentTime = start;
            audioPlayer.play();
            
            setTimeout(() => {
                audioPlayer.pause();
            }, (end - start) * 1000);
        }

        function updateLoop() {
            if(!isPlaying) return;
            
            const curr = audioPlayer.currentTime;
            const pct = (curr / audioPlayer.duration) * 100;
            document.getElementById('seekSlider').value = pct;
            document.getElementById('currentTime').innerText = curr.toFixed(2) + "s";

            // Visual Highlight of "Active" word during playback (Karaoke Style)
            // Note: This is separate from "Selected" word (Blue border) for editing
            const activeIdx = wordTimings.findIndex(t => t && curr >= t.start && curr < t.end);
            
            // We can style the text color to show active playback
            document.querySelectorAll('.sanskrit').forEach((el, i) => {
                if (i === activeIdx) el.classList.add('text-amber-400');
                else el.classList.remove('text-amber-400');
            });

            animationFrame = requestAnimationFrame(updateLoop);
        }

        function saveSyncData() {
            if (!activeScriptId) return;
            const cat = projectData.find(c => c.id === activeCategoryId);
            const script = cat.scripts.find(s => s.id === activeScriptId);

            const content = wordBlocks.map((b, i) => ({
                word: b.sanskrit,
                trans: b.trans,
                start: parseFloat(wordTimings[i]?.start?.toFixed(2) || 0),
                // Ensure end is never less than start
                end: parseFloat(Math.max(wordTimings[i]?.end || 0, wordTimings[i]?.start || 0).toFixed(2))
            }));

            script.content = content;
            alert("Timing saved to Project Data.");
        }

        function exportFullProject() {
            saveCurrentScriptMetadata();
            const json = JSON.stringify(projectData, null, 2);
            document.getElementById('jsonOutput').value = `const DATA = ${json};\n\nexport default DATA;`;
            document.getElementById('exportModal').showModal();
        }

        // Init & Shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                togglePlayback();
            }
            if (e.code === 'Enter') {
                e.preventDefault();
                setKeyframe();
            }
        });

    </script>
</body>
</html>
